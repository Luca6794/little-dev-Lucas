
const translations = {
    'pt-BR': {
        'nav-dashboard': 'Dashboard',
        'nav-cadastro': 'Cadastro',
        'nav-emprestimos': 'Empréstimos',
        'nav-equipamentos': 'Equipamentos',
        
        'welcomeTitle': 'Bem-vindo ao EmpréstSENAI',
        'visaoGeral': 'Visão Geral',
        'totalEquipamentos': 'Total de Equipamentos',
        'emprestimosAtivos': 'Empréstimos Ativos',
        'equipamentosDisponiveis': 'Equipamentos Disponíveis',
        'equipamentosManutencao': 'Em Manutenção',
        'ultimosEmprestimos': 'Últimos Empréstimos:',
        'nenhumEmprestimoRegistrado': 'Nenhum empréstimo registrado ainda.',
        
        'cadastroEquipamentos': 'Cadastro de Equipamentos',
        'codigo': 'Código',
        'tipo': 'Tipo',
        'marca': 'Marca',
        'categoria': 'Categoria',
        'statusInicial': 'Status Inicial',
        'local': 'Local',
        'itemFixo': 'Item Fixo',
        'itemFixoHint': 'Marcar se o item pertence fixamente ao local',
        'condicoes': 'Condições',
        'observacoes': 'Observações',
        'salvar': 'Salvar',
        'limpar': 'Limpar',
        'voltar': 'Voltar',
        
        'placeholderCodigo': 'Ex: EQ-001',
        'placeholderTipo': 'Ex: Notebook',
        'placeholderMarca': 'Ex: Dell',
        'placeholderCategoria': 'Ex: Informática',
        'placeholderLocal': 'Ex: Laboratório 1',
        'placeholderCondicoes': 'Ex: Novo, Bom, Regular',
        'placeholderObservacoes': 'Informações adicionais...',
        
        'gestaoEmprestimos': 'Gestão de Empréstimos',
        'criarEmprestimo': 'Criar Empréstimo',
        'item': 'Item',
        'solicitante': 'Solicitante',
        'dataEmprestimo': 'Data Empréstimo',
        'prazoDevolucao': 'Prazo Devolução',
        'dataDevolucao': 'Data Devolução',
        'danos': 'Danos',
        'criar': 'Criar',
        'emprestimosAtivosTitle': 'Empréstimos Ativos:',
        'devolucoesFinalizadasTitle': 'Devoluções Finalizadas:',
        'verTodos': 'Ver Todos',
        'todosEmprestimosAtivos': 'Todos os Empréstimos Ativos',
        'todasDevolucoes': 'Todas as Devoluções Finalizadas',
        
        'placeholderEmpCodigo': 'Digite o código do equipamento',
        'placeholderEmpItem': 'Preenchido automaticamente',
        'placeholderSolicitante': 'Nome completo',
        'placeholderDanos': 'Descrever danos se houver',
        'placeholderFiltro': 'Filtrar por código, item ou solicitante...',
        
        // Equipamentos
        'equipamentosCadastrados': 'Equipamentos Cadastrados',
        'status': 'Status',
        'fixo': 'Fixo',
        'acoes': 'Ações',
        'editar': 'Editar',
        'excluir': 'Excluir',
        
        // Configurações
        'configuracoes': 'Configurações',
        'modoEscuro': 'Modo Escuro',
        'lingua': 'Idioma',
        
        // Modal
        'editarEquipamento': 'Editar Equipamento',
        'fechar': 'Fechar',
        
        // Status Options
        'disponivel': 'Disponível',
        'emprestado': 'Emprestado',
        'manutencao': 'Em manutenção',
        
        // Mensagens
        'equipamentoCadastrado': 'Equipamento cadastrado com sucesso!',
        'equipamentoAtualizado': 'Equipamento atualizado com sucesso!',
        'equipamentoExcluido': 'Equipamento excluído com sucesso!',
        'emprestimoRegistrado': 'Empréstimo registrado com sucesso!',
        'devolucaoRegistrada': 'Devolução registrada com sucesso!',
        'codigoJaExiste': 'Código já existe!',
        'equipamentoNaoEncontrado': 'Equipamento não encontrado!',
        'equipamentoIndisponivel': 'Este equipamento não está disponível para empréstimo. Status atual:',
        'confirmarExclusao': 'Tem certeza que deseja excluir este equipamento?',
        'confirmarDevolucao': 'Confirmar devolução deste equipamento?',
        'sim': 'Sim',
        'nao': 'Não',
        'devolver': 'Devolver',
        'nenhumEquipamentoCadastrado': 'Nenhum equipamento cadastrado ainda.',
        'nenhumEmprestimoAtivo': 'Nenhum empréstimo ativo no momento.',
        'nenhemDevolucaoFinalizada': 'Nenhuma devolução finalizada.',
    },
    'es': {
        // Navegación
        'nav-dashboard': 'Panel',
        'nav-cadastro': 'Registro',
        'nav-emprestimos': 'Préstamos',
        'nav-equipamentos': 'Equipos',
        
        // Dashboard
        'welcomeTitle': 'Bienvenido a EmpréstSENAI',
        'visaoGeral': 'Vista General',
        'totalEquipamentos': 'Total de Equipos',
        'emprestimosAtivos': 'Préstamos Activos',
        'equipamentosDisponiveis': 'Equipos Disponibles',
        'equipamentosManutencao': 'En Mantenimiento',
        'ultimosEmprestimos': 'Últimos Préstamos:',
        'nenhumEmprestimoRegistrado': 'Aún no hay préstamos registrados.',
        
        // Registro
        'cadastroEquipamentos': 'Registro de Equipos',
        'codigo': 'Código',
        'tipo': 'Tipo',
        'marca': 'Marca',
        'categoria': 'Categoría',
        'statusInicial': 'Estado Inicial',
        'local': 'Ubicación',
        'itemFixo': 'Artículo Fijo',
        'itemFixoHint': 'Marcar si el artículo pertenece fijamente a la ubicación',
        'condicoes': 'Condiciones',
        'observacoes': 'Observaciones',
        'salvar': 'Guardar',
        'limpar': 'Limpiar',
        'voltar': 'Volver',
        
        // Placeholders
        'placeholderCodigo': 'Ej: EQ-001',
        'placeholderTipo': 'Ej: Portátil',
        'placeholderMarca': 'Ej: Dell',
        'placeholderCategoria': 'Ej: Informática',
        'placeholderLocal': 'Ej: Laboratorio 1',
        'placeholderCondicoes': 'Ej: Nuevo, Bueno, Regular',
        'placeholderObservacoes': 'Información adicional...',
        
        // Préstamos
        'gestaoEmprestimos': 'Gestión de Préstamos',
        'criarEmprestimo': 'Crear Préstamo',
        'item': 'Artículo',
        'solicitante': 'Solicitante',
        'dataEmprestimo': 'Fecha Préstamo',
        'prazoDevolucao': 'Plazo Devolución',
        'dataDevolucao': 'Fecha Devolución',
        'danos': 'Daños',
        'criar': 'Crear',
        'emprestimosAtivosTitle': 'Préstamos Activos (3)',
        'devolucoesFinalizadasTitle': 'Devoluciones Finalizadas (3)',
        'verTodos': 'Ver Todos',
        'todosEmprestimosAtivos': 'Todos los Préstamos Activos',
        'todasDevolucoes': 'Todas las Devoluciones Finalizadas',
        
        // Placeholders Préstamos
        'placeholderEmpCodigo': 'Ingrese el código del equipo',
        'placeholderEmpItem': 'Llenado automáticamente',
        'placeholderSolicitante': 'Nombre completo',
        'placeholderDanos': 'Describir daños si hay',
        'placeholderFiltro': 'Filtrar por código, artículo o solicitante...',
        
        // Equipos
        'equipamentosCadastrados': 'Equipos Registrados',
        'status': 'Estado',
        'fixo': 'Fijo',
        'acoes': 'Acciones',
        'editar': 'Editar',
        'excluir': 'Eliminar',
        
        // Configuración
        'configuracoes': 'Configuración',
        'modoEscuro': 'Modo Oscuro',
        'lingua': 'Idioma',
        
        // Modal
        'editarEquipamento': 'Editar Equipo',
        'fechar': 'Cerrar',
        
        // Opciones de Estado
        'disponivel': 'Disponible',
        'emprestado': 'Prestado',
        'manutencao': 'En mantenimiento',
        
        // Mensajes
        'equipamentoCadastrado': '¡Equipo registrado con éxito!',
        'equipamentoAtualizado': '¡Equipo actualizado con éxito!',
        'equipamentoExcluido': '¡Equipo eliminado con éxito!',
        'emprestimoRegistrado': '¡Préstamo registrado con éxito!',
        'devolucaoRegistrada': '¡Devolución registrada con éxito!',
        'codigoJaExiste': '¡El código ya existe!',
        'equipamentoNaoEncontrado': '¡Equipo no encontrado!',
        'equipamentoIndisponivel': 'Este equipo no está disponible para préstamo. Estado actual:',
        'confirmarExclusao': '¿Está seguro de que desea eliminar este equipo?',
        'confirmarDevolucao': '¿Confirmar devolución de este equipo?',
        'sim': 'Sí',
        'nao': 'No',
        'devolver': 'Devolver',
        'nenhumEquipamentoCadastrado': 'Aún no hay equipos registrados.',
        'nenhumEmprestimoAtivo': 'No hay préstamos activos en este momento.',
        'nenhemDevolucaoFinalizada': 'No hay devoluciones finalizadas.',
    },
    'en': {
        // Navigation
        'nav-dashboard': 'Dashboard',
        'nav-cadastro': 'Register',
        'nav-emprestimos': 'Loans',
        'nav-equipamentos': 'Equipment',
        
        // Dashboard
        'welcomeTitle': 'Welcome to EmpréstSENAI',
        'visaoGeral': 'Overview',
        'totalEquipamentos': 'Total Equipment',
        'emprestimosAtivos': 'Active Loans',
        'equipamentosDisponiveis': 'Available Equipment',
        'equipamentosManutencao': 'Under Maintenance',
        'ultimosEmprestimos': 'Recent Loans (3)',
        'nenhumEmprestimoRegistrado': 'No loans registered yet.',
        
        // Register
        'cadastroEquipamentos': 'Equipment Registration',
        'codigo': 'Code',
        'tipo': 'Type',
        'marca': 'Brand',
        'categoria': 'Category',
        'statusInicial': 'Initial Status',
        'local': 'Location',
        'itemFixo': 'Fixed Item',
        'itemFixoHint': 'Check if the item belongs permanently to the location',
        'condicoes': 'Condition',
        'observacoes': 'Notes',
        'salvar': 'Save',
        'limpar': 'Clear',
        'voltar': 'Back',
        
        // Placeholders
        'placeholderCodigo': 'Ex: EQ-001',
        'placeholderTipo': 'Ex: Laptop',
        'placeholderMarca': 'Ex: Dell',
        'placeholderCategoria': 'Ex: IT',
        'placeholderLocal': 'Ex: Lab 1',
        'placeholderCondicoes': 'Ex: New, Good, Fair',
        'placeholderObservacoes': 'Additional information...',
        
        // Loans
        'gestaoEmprestimos': 'Loan Management',
        'criarEmprestimo': 'Create Loan',
        'item': 'Item',
        'solicitante': 'Requester',
        'dataEmprestimo': 'Loan Date',
        'prazoDevolucao': 'Due Date',
        'dataDevolucao': 'Return Date',
        'danos': 'Damage',
        'criar': 'Create',
        'emprestimosAtivosTitle': 'Active Loans (3)',
        'devolucoesFinalizadasTitle': 'Completed Returns (3)',
        'verTodos': 'View All',
        'todosEmprestimosAtivos': 'All Active Loans',
        'todasDevolucoes': 'All Completed Returns',
        
        // Placeholders Loans
        'placeholderEmpCodigo': 'Enter equipment code',
        'placeholderEmpItem': 'Auto-filled',
        'placeholderSolicitante': 'Full name',
        'placeholderDanos': 'Describe damage if any',
        'placeholderFiltro': 'Filter by code, item or requester...',
        
        // Equipment
        'equipamentosCadastrados': 'Registered Equipment',
        'status': 'Status',
        'fixo': 'Fixed',
        'acoes': 'Actions',
        'editar': 'Edit',
        'excluir': 'Delete',
        
        // Settings
        'configuracoes': 'Settings',
        'modoEscuro': 'Dark Mode',
        'lingua': 'Language',
        
        // Modal
        'editarEquipamento': 'Edit Equipment',
        'fechar': 'Close',
        
        // Status Options
        'disponivel': 'Available',
        'emprestado': 'Loaned',
        'manutencao': 'Under maintenance',
        
        // Messages
        'equipamentoCadastrado': 'Equipment registered successfully!',
        'equipamentoAtualizado': 'Equipment updated successfully!',
        'equipamentoExcluido': 'Equipment deleted successfully!',
        'emprestimoRegistrado': 'Loan registered successfully!',
        'devolucaoRegistrada': 'Return registered successfully!',
        'codigoJaExiste': 'Code already exists!',
        'equipamentoNaoEncontrado': 'Equipment not found!',
        'equipamentoIndisponivel': 'This equipment is not available for loan. Current status:',
        'confirmarExclusao': 'Are you sure you want to delete this equipment?',
        'confirmarDevolucao': 'Confirm return of this equipment?',
        'sim': 'Yes',
        'nao': 'No',
        'devolver': 'Return',
        'nenhumEquipamentoCadastrado': 'No equipment registered yet.',
        'nenhumEmprestimoAtivo': 'No active loans at the moment.',
        'nenhemDevolucaoFinalizada': 'No completed returns.',
    }
};

// ============ ESTADO GLOBAL ============
let currentLanguage = localStorage.getItem('language') || 'pt-BR';
let equipamentos = JSON.parse(localStorage.getItem('equipamentos')) || [];
let emprestimos = JSON.parse(localStorage.getItem('emprestimos')) || [];

// ============ FUNÇÕES DE TRADUÇÃO ============
function translate(key) {
    return translations[currentLanguage][key] || key;
}

function updatePageTranslations() {
    // Traduzir todos os elementos com data-translate
    document.querySelectorAll('[data-translate]').forEach(element => {
        const key = element.getAttribute('data-translate');
        element.textContent = translate(key);
    });
    
    // Traduzir placeholders
    document.querySelectorAll('[data-translate-placeholder]').forEach(element => {
        const key = element.getAttribute('data-translate-placeholder');
        element.placeholder = translate(key);
    });
    
    // Traduzir opções de select
    document.querySelectorAll('[data-translate-option]').forEach(option => {
        const key = option.getAttribute('data-translate-option');
        option.textContent = translate(key);
    });
    
    // Atualizar idioma do HTML
    document.documentElement.lang = currentLanguage;
}

function setLanguage(lang) {
    currentLanguage = lang;
    localStorage.setItem('language', lang);
    updatePageTranslations();
    
    // Recarregar tabelas e dados para aplicar traduções
    renderEquipamentosTable();
    renderEmprestimosAtivosPreview();
    renderDevolucoesFinalizadasPreview();
    updateStats();
}

// ============ NAVEGAÇÃO ============
function showSection(sectionId) {
    // Remover active de todas as seções e botões
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Ativar seção e botão
    document.getElementById(sectionId).classList.add('active');
    const activeBtn = document.querySelector(`[data-section="${sectionId}"]`);
    if (activeBtn) activeBtn.classList.add('active');
}

// ============ ESTATÍSTICAS DASHBOARD ============
function updateStats() {
    const totalEquipamentos = equipamentos.length;
    const emprestimosAtivos = emprestimos.filter(e => !e.dataDevolucao).length;
    const equipamentosDisponiveis = equipamentos.filter(e => e.status === 'Disponível').length;
    const equipamentosManutencao = equipamentos.filter(e => e.status === 'Em manutenção').length;
    
    document.getElementById('stat-total-equipamentos').textContent = totalEquipamentos;
    document.getElementById('stat-emprestimos-ativos').textContent = emprestimosAtivos;
    document.getElementById('stat-equipamentos-disponiveis').textContent = equipamentosDisponiveis;
    document.getElementById('stat-equipamentos-manutencao').textContent = equipamentosManutencao;
    
    renderRecentLoans();
}

function renderRecentLoans() {
    const container = document.getElementById('recent-loans-container');
    const recent = emprestimos.filter(e => !e.dataDevolucao).slice(0, 3);
    
    if (recent.length === 0) {
        container.innerHTML = `<p class="empty-state">${translate('nenhumEmprestimoRegistrado')}</p>`;
        return;
    }
    
    container.innerHTML = recent.map(emp => {
        const equip = equipamentos.find(e => e.codigo === emp.codigo);
        return `
            <div class="recent-loan-item">
                <div class="loan-info">
                    <span class="loan-label">${translate('codigo')}</span>
                    <span class="loan-value">${emp.codigo}</span>
                </div>
                <div class="loan-info">
                    <span class="loan-label">${translate('item')}</span>
                    <span class="loan-value">${equip ? equip.tipo : '-'}</span>
                </div>
                <div class="loan-info">
                    <span class="loan-label">${translate('solicitante')}</span>
                    <span class="loan-value">${emp.solicitante}</span>
                </div>
                <div class="loan-info">
                    <span class="loan-label">${translate('prazoDevolucao')}</span>
                    <span class="loan-value">${formatDateTime(emp.prazoDevolucao)}</span>
                </div>
            </div>
        `;
    }).join('');
}

// ============ CADASTRO DE EQUIPAMENTOS ============
document.getElementById('form-cadastro').addEventListener('submit', (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const equipamento = {
        id: Date.now().toString(),
        codigo: formData.get('codigo'),
        tipo: formData.get('tipo'),
        marca: formData.get('marca'),
        categoria: formData.get('categoria'),
        status: formData.get('status'),
        local: formData.get('local'),
        fixo: formData.get('fixo') === 'on',
        condicoes: formData.get('condicoes') || '',
        observacoes: formData.get('observacoes') || ''
    };
    
    // Verificar se código já existe
    if (equipamentos.some(e => e.codigo === equipamento.codigo)) {
        showValidationMessage(translate('codigoJaExiste'), 'error');
        return;
    }
    
    equipamentos.push(equipamento);
    localStorage.setItem('equipamentos', JSON.stringify(equipamentos));
    
    showValidationMessage(translate('equipamentoCadastrado'), 'success');
    e.target.reset();
    updateStats();
    renderEquipamentosTable();
});

document.getElementById('btn-limpar').addEventListener('click', () => {
    document.getElementById('form-cadastro').reset();
});

document.getElementById('btn-voltar-cadastro').addEventListener('click', () => {
    showSection('dashboard');
});

// ============ EMPRÉSTIMOS ============
// Autopreenchimento do item ao digitar código
document.getElementById('emp-codigo').addEventListener('input', (e) => {
    const codigo = e.target.value.trim();
    const equipamento = equipamentos.find(eq => eq.codigo === codigo);
    const itemInput = document.getElementById('emp-item');
    
    if (equipamento) {
        itemInput.value = `${equipamento.tipo} - ${equipamento.marca}`;
    } else {
        itemInput.value = '';
    }
});

document.getElementById('form-emprestimo').addEventListener('submit', (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const codigo = formData.get('codigo');
    
    // Validar se equipamento existe
    const equipamento = equipamentos.find(eq => eq.codigo === codigo);
    if (!equipamento) {
        showValidationMessage(translate('equipamentoNaoEncontrado'), 'error');
        return;
    }
    
    // Validar se equipamento está disponível (não pode estar Emprestado ou Em manutenção)
    if (equipamento.status === 'Emprestado' || equipamento.status === 'Em manutenção') {
        showValidationMessage(`${translate('equipamentoIndisponivel')} ${equipamento.status}`, 'error');
        return;
    }
    
    const emprestimo = {
        id: Date.now().toString(),
        codigo: codigo,
        item: formData.get('item'),
        solicitante: formData.get('solicitante'),
        dataEmprestimo: formData.get('dataEmprestimo'),
        prazoDevolucao: formData.get('prazoDevolucao'),
        danos: formData.get('danos') || '',
        dataDevolucao: null
    };
    
    emprestimos.push(emprestimo);
    localStorage.setItem('emprestimos', JSON.stringify(emprestimos));
    
    // Atualizar status do equipamento para Emprestado
    equipamento.status = 'Emprestado';
    localStorage.setItem('equipamentos', JSON.stringify(equipamentos));
    
    showValidationMessage(translate('emprestimoRegistrado'), 'success');
    e.target.reset();
    updateStats();
    renderEmprestimosAtivosPreview();
    renderEquipamentosTable();
});

document.getElementById('btn-limpar-emprestimo').addEventListener('click', () => {
    document.getElementById('form-emprestimo').reset();
    hideValidationMessage();
});

// ============ EMPRÉSTIMOS ATIVOS PREVIEW (3) ============
function renderEmprestimosAtivosPreview() {
    const container = document.getElementById('emprestimos-ativos-preview');
    const ativos = emprestimos.filter(e => !e.dataDevolucao).slice(0, 3);
    
    if (ativos.length === 0) {
        container.innerHTML = `
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>${translate('codigo')}</th>
                            <th>${translate('item')}</th>
                            <th>${translate('solicitante')}</th>
                            <th>${translate('dataEmprestimo')}</th>
                            <th>${translate('prazoDevolucao')}</th>
                            <th>${translate('danos')}</th>
                            <th>${translate('acoes')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="7" class="empty-row">${translate('nenhumEmprestimoAtivo')}</td></tr>
                    </tbody>
                </table>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>${translate('codigo')}</th>
                        <th>${translate('item')}</th>
                        <th>${translate('solicitante')}</th>
                        <th>${translate('dataEmprestimo')}</th>
                        <th>${translate('prazoDevolucao')}</th>
                        <th>${translate('danos')}</th>
                        <th>${translate('acoes')}</th>
                    </tr>
                </thead>
                <tbody>
                    ${ativos.map(emp => `
                        <tr>
                            <td>${emp.codigo}</td>
                            <td>${emp.item}</td>
                            <td>${emp.solicitante}</td>
                            <td>${formatDateTime(emp.dataEmprestimo)}</td>
                            <td>${formatDateTime(emp.prazoDevolucao)}</td>
                            <td>${emp.danos || '-'}</td>
                            <td>
                                <button class="btn btn-small btn-primary" onclick="devolverEquipamento('${emp.id}')">
                                    ${translate('devolver')}
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

// ============ DEVOLUÇÕES FINALIZADAS PREVIEW (3) ============
function renderDevolucoesFinalizadasPreview() {
    const container = document.getElementById('devolucoes-finalizadas-preview');
    const finalizados = emprestimos.filter(e => e.dataDevolucao).slice(0, 3);
    
    if (finalizados.length === 0) {
        container.innerHTML = `
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>${translate('codigo')}</th>
                            <th>${translate('item')}</th>
                            <th>${translate('solicitante')}</th>
                            <th>${translate('dataEmprestimo')}</th>
                            <th>${translate('prazoDevolucao')}</th>
                            <th>${translate('dataDevolucao')}</th>
                            <th>${translate('danos')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="7" class="empty-row">${translate('nenhemDevolucaoFinalizada')}</td></tr>
                    </tbody>
                </table>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>${translate('codigo')}</th>
                        <th>${translate('item')}</th>
                        <th>${translate('solicitante')}</th>
                        <th>${translate('dataEmprestimo')}</th>
                        <th>${translate('prazoDevolucao')}</th>
                        <th>${translate('dataDevolucao')}</th>
                        <th>${translate('danos')}</th>
                    </tr>
                </thead>
                <tbody>
                    ${finalizados.map(emp => `
                        <tr>
                            <td>${emp.codigo}</td>
                            <td>${emp.item}</td>
                            <td>${emp.solicitante}</td>
                            <td>${formatDateTime(emp.dataEmprestimo)}</td>
                            <td>${formatDateTime(emp.prazoDevolucao)}</td>
                            <td>${formatDateTime(emp.dataDevolucao)}</td>
                            <td>${emp.danos || '-'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

// ============ EMPRÉSTIMOS ATIVOS EXPANDIDO ============
document.getElementById('btn-ver-todos-ativos').addEventListener('click', () => {
    showSection('emprestimos-ativos-expandido');
    renderEmprestimosAtivosExpandido();
});

document.getElementById('btn-voltar-ativos').addEventListener('click', () => {
    showSection('emprestimos');
});

function renderEmprestimosAtivosExpandido(filtro = '') {
    const tbody = document.querySelector('#tabela-ativos-expandido tbody');
    let ativos = emprestimos.filter(e => !e.dataDevolucao);
    
    if (filtro) {
        ativos = ativos.filter(emp => 
            emp.codigo.toLowerCase().includes(filtro.toLowerCase()) ||
            emp.item.toLowerCase().includes(filtro.toLowerCase()) ||
            emp.solicitante.toLowerCase().includes(filtro.toLowerCase())
        );
    }
    
    if (ativos.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="empty-row">${translate('nenhumEmprestimoAtivo')}</td></tr>`;
        return;
    }
    
    tbody.innerHTML = ativos.map(emp => `
        <tr>
            <td>${emp.codigo}</td>
            <td>${emp.item}</td>
            <td>${emp.solicitante}</td>
            <td>${formatDateTime(emp.dataEmprestimo)}</td>
            <td>${formatDateTime(emp.prazoDevolucao)}</td>
            <td>${emp.danos || '-'}</td>
            <td>
                <button class="btn btn-small btn-primary" onclick="devolverEquipamento('${emp.id}')">
                    ${translate('devolver')}
                </button>
            </td>
        </tr>
    `).join('');
}

document.getElementById('filtro-ativos-expandido').addEventListener('input', (e) => {
    renderEmprestimosAtivosExpandido(e.target.value);
});

// ============ DEVOLUÇÕES FINALIZADAS EXPANDIDO ============
document.getElementById('btn-ver-todos-finalizados').addEventListener('click', () => {
    showSection('devolucoes-finalizadas-expandido');
    renderDevolucoesFinalizadasExpandido();
});

document.getElementById('btn-voltar-finalizados').addEventListener('click', () => {
    showSection('emprestimos');
});

function renderDevolucoesFinalizadasExpandido(filtro = '') {
    const tbody = document.querySelector('#tabela-finalizados-expandido tbody');
    let finalizados = emprestimos.filter(e => e.dataDevolucao);
    
    if (filtro) {
        finalizados = finalizados.filter(emp => 
            emp.codigo.toLowerCase().includes(filtro.toLowerCase()) ||
            emp.item.toLowerCase().includes(filtro.toLowerCase()) ||
            emp.solicitante.toLowerCase().includes(filtro.toLowerCase())
        );
    }
    
    if (finalizados.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="empty-row">${translate('nenhemDevolucaoFinalizada')}</td></tr>`;
        return;
    }
    
    tbody.innerHTML = finalizados.map(emp => `
        <tr>
            <td>${emp.codigo}</td>
            <td>${emp.item}</td>
            <td>${emp.solicitante}</td>
            <td>${formatDateTime(emp.dataEmprestimo)}</td>
            <td>${formatDateTime(emp.prazoDevolucao)}</td>
            <td>${formatDateTime(emp.dataDevolucao)}</td>
            <td>${emp.danos || '-'}</td>
        </tr>
    `).join('');
}

document.getElementById('filtro-finalizados-expandido').addEventListener('input', (e) => {
    renderDevolucoesFinalizadasExpandido(e.target.value);
});

// ============ DEVOLUÇÃO ============
function devolverEquipamento(emprestimoId) {
    if (!confirm(translate('confirmarDevolucao'))) return;
    
    const emprestimo = emprestimos.find(e => e.id === emprestimoId);
    if (!emprestimo) return;
    
    // Registrar data de devolução
    emprestimo.dataDevolucao = new Date().toISOString();
    localStorage.setItem('emprestimos', JSON.stringify(emprestimos));
    
    // Atualizar status do equipamento para Disponível
    const equipamento = equipamentos.find(eq => eq.codigo === emprestimo.codigo);
    if (equipamento) {
        equipamento.status = 'Disponível';
        localStorage.setItem('equipamentos', JSON.stringify(equipamentos));
    }
    
    showValidationMessage(translate('devolucaoRegistrada'), 'success');
    updateStats();
    renderEmprestimosAtivosPreview();
    renderDevolucoesFinalizadasPreview();
    renderEmprestimosAtivosExpandido();
    renderDevolucoesFinalizadasExpandido();
    renderEquipamentosTable();
}

// ============ EQUIPAMENTOS TABLE ============
function renderEquipamentosTable(filtro = '') {
    const tbody = document.querySelector('#tabela-equipamentos tbody');
    let lista = equipamentos;
    
    if (filtro) {
        lista = equipamentos.filter(eq => 
            eq.codigo.toLowerCase().includes(filtro.toLowerCase()) ||
            eq.tipo.toLowerCase().includes(filtro.toLowerCase()) ||
            eq.marca.toLowerCase().includes(filtro.toLowerCase()) ||
            eq.categoria.toLowerCase().includes(filtro.toLowerCase())
        );
    }
    
    if (lista.length === 0) {
        tbody.innerHTML = `<tr><td colspan="10" class="empty-row">${translate('nenhumEquipamentoCadastrado')}</td></tr>`;
        return;
    }
    
    tbody.innerHTML = lista.map(eq => `
        <tr>
            <td>${eq.codigo}</td>
            <td>${eq.tipo}</td>
            <td>${eq.marca}</td>
            <td>${eq.categoria}</td>
            <td><span class="status-badge status-${getStatusClass(eq.status)}">${translate(getStatusKey(eq.status))}</span></td>
            <td>${eq.local}</td>
            <td>${eq.fixo ? translate('sim') : translate('nao')}</td>
            <td>${eq.condicoes || '-'}</td>
            <td>${eq.observacoes || '-'}</td>
            <td>
                <button class="btn btn-small btn-secondary" onclick="editarEquipamento('${eq.id}')">
                    ${translate('editar')}
                </button>
                <button class="btn btn-small btn-tertiary" onclick="excluirEquipamento('${eq.id}')">
                    ${translate('excluir')}
                </button>
            </td>
        </tr>
    `).join('');
}

document.getElementById('filtro-equipamentos').addEventListener('input', (e) => {
    renderEquipamentosTable(e.target.value);
});

function getStatusClass(status) {
    if (status === 'Disponível') return 'disponivel';
    if (status === 'Emprestado') return 'emprestado';
    if (status === 'Em manutenção') return 'manutencao';
    return 'disponivel';
}

function getStatusKey(status) {
    if (status === 'Disponível') return 'disponivel';
    if (status === 'Emprestado') return 'emprestado';
    if (status === 'Em manutenção') return 'manutencao';
    return 'disponivel';
}

// ============ EDITAR EQUIPAMENTO ============
function editarEquipamento(id) {
    const equipamento = equipamentos.find(e => e.id === id);
    if (!equipamento) return;
    
    document.getElementById('edit-id').value = equipamento.id;
    document.getElementById('edit-codigo').value = equipamento.codigo;
    document.getElementById('edit-tipo').value = equipamento.tipo;
    document.getElementById('edit-marca').value = equipamento.marca;
    document.getElementById('edit-categoria').value = equipamento.categoria;
    document.getElementById('edit-status').value = equipamento.status;
    document.getElementById('edit-local').value = equipamento.local;
    document.getElementById('edit-fixo').checked = equipamento.fixo;
    document.getElementById('edit-condicoes').value = equipamento.condicoes;
    document.getElementById('edit-observacoes').value = equipamento.observacoes;
    
    document.getElementById('modal-editar').classList.add('active');
}

document.getElementById('form-editar').addEventListener('submit', (e) => {
    e.preventDefault();
    
    const id = document.getElementById('edit-id').value;
    const equipamento = equipamentos.find(e => e.id === id);
    if (!equipamento) return;
    
    equipamento.codigo = document.getElementById('edit-codigo').value;
    equipamento.tipo = document.getElementById('edit-tipo').value;
    equipamento.marca = document.getElementById('edit-marca').value;
    equipamento.categoria = document.getElementById('edit-categoria').value;
    equipamento.status = document.getElementById('edit-status').value;
    equipamento.local = document.getElementById('edit-local').value;
    equipamento.fixo = document.getElementById('edit-fixo').checked;
    equipamento.condicoes = document.getElementById('edit-condicoes').value;
    equipamento.observacoes = document.getElementById('edit-observacoes').value;
    
    localStorage.setItem('equipamentos', JSON.stringify(equipamentos));
    
    document.getElementById('modal-editar').classList.remove('active');
    renderEquipamentosTable();
    updateStats();
    showValidationMessage(translate('equipamentoAtualizado'), 'success');
});

// ============ EXCLUIR EQUIPAMENTO ============
function excluirEquipamento(id) {
    if (!confirm(translate('confirmarExclusao'))) return;
    
    equipamentos = equipamentos.filter(e => e.id !== id);
    localStorage.setItem('equipamentos', JSON.stringify(equipamentos));
    
    renderEquipamentosTable();
    updateStats();
    showValidationMessage(translate('equipamentoExcluido'), 'success');
}

// ============ MODAL ============
document.querySelectorAll('.modal-close').forEach(btn => {
    btn.addEventListener('click', () => {
        document.getElementById('modal-editar').classList.remove('active');
    });
});

document.getElementById('modal-editar').addEventListener('click', (e) => {
    if (e.target.id === 'modal-editar') {
        document.getElementById('modal-editar').classList.remove('active');
    }
});

// ============ CONFIGURAÇÕES ============
// Modo Escuro
const darkModeToggle = document.getElementById('toggle-dark-mode');
const isDarkMode = localStorage.getItem('darkMode') === 'true';

if (isDarkMode) {
    document.body.classList.add('dark-mode');
    darkModeToggle.checked = true;
}

darkModeToggle.addEventListener('change', () => {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
});

// Idioma
document.querySelectorAll('input[name="language"]').forEach(radio => {
    if (radio.value === currentLanguage) {
        radio.checked = true;
    }
    
    radio.addEventListener('change', (e) => {
        setLanguage(e.target.value);
    });
});

// ============ NAVEGAÇÃO EVENTOS ============
document.querySelectorAll('.nav-btn[data-section]').forEach(btn => {
    btn.addEventListener('click', () => {
        const section = btn.getAttribute('data-section');
        showSection(section);
    });
});

// ============ FUNÇÕES UTILITÁRIAS ============
function formatDateTime(dateTimeString) {
    if (!dateTimeString) return '-';
    const date = new Date(dateTimeString);
    return date.toLocaleString(currentLanguage, {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function showValidationMessage(message, type) {
    const messageDiv = document.getElementById('validation-message');
    if (!messageDiv) return;
    
    messageDiv.textContent = message;
    messageDiv.className = `validation-message ${type}`;
    messageDiv.classList.remove('hidden');
    
    setTimeout(() => {
        messageDiv.classList.add('hidden');
    }, 5000);
}

function hideValidationMessage() {
    const messageDiv = document.getElementById('validation-message');
    if (messageDiv) {
        messageDiv.classList.add('hidden');
    }
}

// ============ INICIALIZAÇÃO ============
document.addEventListener('DOMContentLoaded', () => {
    updatePageTranslations();
    updateStats();
    renderEquipamentosTable();
    renderEmprestimosAtivosPreview();
    renderDevolucoesFinalizadasPreview();
});
